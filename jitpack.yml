## 适配AGP 9.0.0的JitPack配置（必须指定Java 17）
#jdk:
#  - openjdk17
## 自动编译指定Module的Release版aar
#install:
#  - ./gradlew :ads2_sdk_savedoge:assembleRelease

# 核心：先安装并激活JDK 17（解决AGP 9.0.0 + Gradle 9.1.0的版本要求）
before_install:
  # 安装SDKMan（JDK管理工具）
  - curl -s "https://get.sdkman.io" | bash
  - source "$HOME/.sdkman/bin/sdkman-init.sh"
  # 安装并激活JDK 17（指定稳定版本）
  - sdk install java 17.0.12-oracle
  - sdk use java 17.0.12-oracle
  # 强制设置JAVA_HOME和PATH，确保全局使用JDK 17
  - export JAVA_HOME="$HOME/.sdkman/candidates/java/17.0.12-oracle"
  - export PATH="$JAVA_HOME/bin:$PATH"
  # 写入gradle.properties，强制Gradle使用JDK 17
  - echo "org.gradle.java.home=$JAVA_HOME" >> gradle.properties
  # 验证JDK版本（排查用）
  - java -version

# 编译Module的Release版aar（禁用Daemon避免版本复用）
install:
  - ./gradlew :ads2_sdk_savedoge:assembleRelease --info --no-daemon

# 复制aar到JitPack识别的目录 + 生成标准pom.xml
after_install:
  # 定义GAV坐标（严格匹配你的项目）
  - GROUP_ID="com.github.zc"
  - ARTIFACT_ID="ads2_sdk_savedoge"
  - VERSION="v1.0.3"

  # 创建Maven标准目录结构
  - mkdir -p ~/.m2/repository/${GROUP_ID//.//}/${ARTIFACT_ID}/${VERSION}/

  # 验证aar是否存在，不存在则终止构建（避免空文件）
  - if [ ! -f "ads2_sdk_savedoge/build/outputs/aar/ads2_sdk_savedoge-release.aar" ]; then
    echo "ERROR: aar file not found in ads2_sdk_savedoge/build/outputs/aar/";
    exit 1;
    fi

  # 复制aar文件到Maven目录
  - cp ads2_sdk_savedoge/build/outputs/aar/ads2_sdk_savedoge-release.aar ~/.m2/repository/${GROUP_ID//.//}/${ARTIFACT_ID}/${VERSION}/${ARTIFACT_ID}-${VERSION}.aar

  # 生成pom.xml（包含所有依赖传递，格式无错误）
  - |
    cat > ~/.m2/repository/${GROUP_ID//.//}/${ARTIFACT_ID}/${VERSION}/${ARTIFACT_ID}-${VERSION}.pom << EOF
    <?xml version="1.0" encoding="UTF-8"?>
    <project xmlns="http://maven.apache.org/POM/4.0.0" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:schemaLocation="http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd">
      <modelVersion>4.0.0</modelVersion>
      <groupId>${GROUP_ID}</groupId>
      <artifactId>${ARTIFACT_ID}</artifactId>
      <version>${VERSION}</version>
      <packaging>aar</packaging>
      <dependencies>
#        <!-- androidx核心依赖 -->
#        <dependency>
#          <groupId>androidx.core</groupId>
#          <artifactId>core-ktx</artifactId>
#          <version>1.12.0</version>
#          <scope>compile</scope>
#        </dependency>
#        <dependency>
#          <groupId>androidx.appcompat</groupId>
#          <artifactId>appcompat</artifactId>
#          <version>1.6.1</version>
#          <scope>compile</scope>
#        </dependency>
#        <dependency>
#          <groupId>com.google.android.material</groupId>
#          <artifactId>material</artifactId>
#          <version>1.12.0</version>
#          <scope>compile</scope>
#        </dependency>
#        <!-- 测试依赖 -->
#        <dependency>
#          <groupId>junit</groupId>
#          <artifactId>junit</artifactId>
#          <version>4.13.2</version>
#          <scope>test</scope>
#        </dependency>
#        <dependency>
#          <groupId>androidx.test.ext</groupId>
#          <artifactId>junit</artifactId>
#          <version>1.1.5</version>
#          <scope>androidTest</scope>
#        </dependency>
#        <dependency>
#          <groupId>androidx.test.espresso</groupId>
#          <artifactId>espresso-core</artifactId>
#          <version>3.5.1</version>
#          <scope>androidTest</scope>
#        </dependency>
        <!-- Monetize SDK核心 -->
        <dependency>
          <groupId>com.monetize</groupId>
          <artifactId>monetize-core-savedoge-sdk</artifactId>
          <version>1.0.1</version>
          <scope>compile</scope>
        </dependency>
        <!-- Ktor网络依赖（3.1.2） -->
        <dependency>
          <groupId>io.ktor</groupId>
          <artifactId>ktor-client-core</artifactId>
          <version>3.1.2</version>
          <scope>compile</scope>
        </dependency>
        <dependency>
          <groupId>io.ktor</groupId>
          <artifactId>ktor-client-okhttp</artifactId>
          <version>3.1.2</version>
          <scope>compile</scope>
        </dependency>
        <dependency>
          <groupId>io.ktor</groupId>
          <artifactId>ktor-client-content-negotiation</artifactId>
          <version>3.1.2</version>
          <scope>compile</scope>
        </dependency>
        <dependency>
          <groupId>io.ktor</groupId>
          <artifactId>ktor-serialization-kotlinx-json</artifactId>
          <version>3.1.2</version>
          <scope>compile</scope>
        </dependency>
        <!-- 其他运行时依赖 -->
        <dependency>
          <groupId>dev.whyoleg.cryptography</groupId>
          <artifactId>cryptography-provider-jdk</artifactId>
          <version>0.4.0</version>
          <scope>compile</scope>
        </dependency>
        <dependency>
          <groupId>org.jetbrains.kotlinx</groupId>
          <artifactId>kotlinx-datetime</artifactId>
          <version>0.6.1</version>
          <scope>compile</scope>
        </dependency>
        <dependency>
          <groupId>com.squareup.okio</groupId>
          <artifactId>okio</artifactId>
          <version>3.9.1</version>
          <scope>compile</scope>
        </dependency>
        <dependency>
          <groupId>androidx.webkit</groupId>
          <artifactId>webkit</artifactId>
          <version>1.15.0</version>
          <scope>compile</scope>
        </dependency>
        <dependency>
          <groupId>org.jetbrains.kotlinx</groupId>
          <artifactId>kotlinx-serialization-json</artifactId>
          <version>1.6.3</version>
          <scope>compile</scope>
        </dependency>
        <!-- desugaring依赖（Java 8+兼容） -->
        <dependency>
          <groupId>com.android.tools</groupId>
          <artifactId>desugar_jdk_libs</artifactId>
          <version>2.1.5</version>
          <scope>compile</scope>
        </dependency>
      </dependencies>
    </project>
    EOF

# 验证产物是否生成成功（可选，便于排查）
after_success:
  - ls -la ~/.m2/repository/${GROUP_ID//.//}/${ARTIFACT_ID}/${VERSION}/
  - echo "✅ Build success! Artifacts copied to Maven repo."
  - echo "✅ JDK Version: $(java -version 2>&1 | head -1)"
